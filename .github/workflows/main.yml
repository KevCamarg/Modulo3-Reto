name: CI/CD con Security Gates

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  SOLUTION_FILE: '**/*.sln'  # Busca automáticamente tu .sln
  BUILD_CONFIGURATION: Release
  
jobs:
  # ==================== ETAPA 1: BUILD Y TEST ====================
  build-and-test:
    name: Build y Tests Unitarios
    runs-on: windows-latest
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v3
    
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1
    
    - name: Buscar archivos de proyecto
      id: find-projects
      run: |
        # Buscar .sln primero
        $sln = Get-ChildItem -Recurse -Filter "*.sln" | Select-Object -First 1
        
        # Si no hay .sln, buscar .csproj
        if (-not $sln) {
          $csproj = Get-ChildItem -Recurse -Filter "*.csproj" | Where-Object { $_.Name -notlike "*Tests*" } | Select-Object -First 1
          if ($csproj) {
            Write-Host "✅ Proyecto encontrado: $($csproj.FullName)"
            echo "PROJECT_PATH=$($csproj.FullName)" >> $env:GITHUB_OUTPUT
            echo "PROJECT_DIR=$($csproj.DirectoryName)" >> $env:GITHUB_OUTPUT
            echo "USE_CSPROJ=true" >> $env:GITHUB_OUTPUT
          }
        } else {
          Write-Host "✅ Solución encontrada: $($sln.FullName)"
          echo "PROJECT_PATH=$($sln.FullName)" >> $env:GITHUB_OUTPUT
          echo "PROJECT_DIR=$($sln.DirectoryName)" >> $env:GITHUB_OUTPUT
          echo "USE_CSPROJ=false" >> $env:GITHUB_OUTPUT
        }
    
    - name: Restaurar paquetes NuGet
      run: |
        cd "${{ steps.find-projects.outputs.PROJECT_DIR }}"
        nuget restore "${{ steps.find-projects.outputs.PROJECT_PATH }}"
    
    - name: Compilar proyecto
      run: msbuild "${{ steps.find-projects.outputs.PROJECT_PATH }}" /p:Configuration=${{ env.BUILD_CONFIGURATION }} /p:Platform="Any CPU"
    
    - name: Ejecutar tests unitarios
      run: |
        # Buscar DLL de tests
        $testDll = Get-ChildItem -Path . -Filter "*Tests.dll" -Recurse | Where-Object { $_.FullName -like "*bin\${{ env.BUILD_CONFIGURATION }}*" } | Select-Object -First 1
        
        if ($testDll) {
          Write-Host "✅ Tests encontrados en: $($testDll.FullName)"
          
          # Crear carpeta para resultados
          New-Item -ItemType Directory -Force -Path "TestResults"
          
          # Ejecutar tests con vstest
          $vstest = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\IDE\CommonExtensions\Microsoft\TestWindow\vstest.console.exe"
          if (Test-Path $vstest) {
            & $vstest $testDll.FullName /Logger:"trx;LogFileName=TestResults.trx" /ResultsDirectory:"TestResults"
          } else {
            Write-Host "⚠️ vstest no encontrado, intentando con dotnet test"
            dotnet test $testDll.FullName --logger "trx;LogFileName=TestResults.trx" --results-directory "TestResults"
          }
          
          Write-Host "✅ Tests ejecutados"
        } else {
          Write-Host "⚠️ No se encontraron archivos de tests (*Tests.dll)"
          Write-Host "Esto puede ser normal si no tienes proyecto de tests"
          exit 0
        }
      continue-on-error: false
    
    - name: Publicar resultados de tests
      uses: EnricoMi/publish-unit-test-result-action/composite@v2
      if: always()
      with:
        files: 'TestResults/**/*.trx'
        check_name: 'Test Results'
    - name: Subir artefactos de build
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          **/bin/${{ env.BUILD_CONFIGURATION }}/*.dll
          **/bin/${{ env.BUILD_CONFIGURATION }}/*.exe

 


  # ==================== ETAPA 2: ANÁLISIS DE SEGURIDAD ====================
  security-scan:
    name: Escaneo de Seguridad
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v3
    
    - name: Escaneo de secretos con TruffleHog
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD
    
    - name: Análisis de código JavaScript
      if: always()
      run: |
        npm init -y
        npm install eslint eslint-plugin-security --save-dev
        cat > .eslintrc.json << 'EOF'
        {
          "extends": ["eslint:recommended"],
          "plugins": ["security"],
          "env": { "browser": true, "es2021": true },
          "rules": {
            "no-eval": "error",
            "no-implied-eval": "error",
            "security/detect-eval-with-expression": "error",
            "security/detect-unsafe-regex": "error"
          }
        }
        EOF
        npx eslint "**/*.js" || echo "⚠️ Se encontraron problemas de seguridad en JS"

  # ==================== ETAPA 3: CODEQL ANALYSIS ====================
  codeql:
    name: Análisis CodeQL
    runs-on: windows-latest
    needs: build-and-test
    permissions:
      security-events: write
      actions: read
      contents: read
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v3
    
    - name: Inicializar CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: csharp, javascript
        queries: security-and-quality
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1
    
    - name: Restaurar y compilar
      run: |
        nuget restore
        msbuild /p:Configuration=Release
    
    - name: Ejecutar análisis CodeQL
      uses: github/codeql-action/analyze@v2
      with:
        category: "/language:csharp,javascript"

  # ==================== ETAPA 4: QUALITY GATE ====================
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan, codeql]
    
    steps:
    - name: Verificar que todos los checks pasaron
      run: |
        echo "✅ Build: PASSED"
        echo "✅ Tests: PASSED"
        echo "✅ Security Scan: PASSED"
        echo "✅ CodeQL: PASSED"
        echo ""
        echo "🎉 Quality Gate: APPROVED"
        echo "✅ Listo para deploy"
    
    - name: Crear badge de status
      run: |
        echo "![Build Status](https://img.shields.io/badge/build-passing-brightgreen)" 
        echo "![Tests](https://img.shields.io/badge/tests-passing-brightgreen)"
        echo "![Security](https://img.shields.io/badge/security-passing-brightgreen)"

  # ==================== NOTIFICACIONES ====================
  notify-failure:
    name: Notificar Fallos
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan, codeql]
    if: failure()
    
    steps:
    - name: Notificación de fallo
      run: |
        echo "❌ El pipeline ha fallado"
        echo "Revisa los logs en: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
