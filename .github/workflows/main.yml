name: CI/CD con Security Gates

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  SOLUTION_FILE: '**/*.sln'  # Busca automáticamente tu .sln
  BUILD_CONFIGURATION: Release
  
jobs:
  # ==================== ETAPA 1: BUILD Y TEST ====================
  build-and-test:
    name: Build y Tests Unitarios
    runs-on: windows-latest
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v3
    
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1
    
    - name: Buscar archivos de proyecto
      id: find-projects
      run: |
        # Buscar directorio base con packages
        $baseDir = Get-Location
        Write-Host "📁 Directorio base: $baseDir"
        
        # Buscar todos los packages.config
        $packagesConfigs = Get-ChildItem -Recurse -Filter "packages.config"
        Write-Host "📦 Encontrados $($packagesConfigs.Count) archivos packages.config"
        
        echo "BASE_DIR=$baseDir" >> $env:GITHUB_OUTPUT
    
    - name: Restaurar TODOS los paquetes NuGet
      run: |
        # Restaurar desde packages.config
        Get-ChildItem -Recurse -Filter "packages.config" | ForEach-Object {
          Write-Host "📦 Restaurando: $($_.FullName)"
          nuget restore $_.FullName -PackagesDirectory "packages" -NonInteractive
        }
        
        # Restaurar desde .csproj también
        Get-ChildItem -Recurse -Filter "*.csproj" | ForEach-Object {
          Write-Host "📦 Restaurando proyecto: $($_.Name)"
          nuget restore $_.FullName -PackagesDirectory "packages" -NonInteractive
        }
    
    - name: Compilar proyectos
      run: |
        # Compilar proyecto principal
        $mainProj = Get-ChildItem -Recurse -Filter "*.csproj" | Where-Object { $_.Name -notlike "*Tests*" } | Select-Object -First 1
        if ($mainProj) {
          Write-Host "🔨 Compilando: $($mainProj.Name)"
          msbuild $mainProj.FullName /p:Configuration=${{ env.BUILD_CONFIGURATION }} /t:Rebuild
        }
        
        # Compilar tests
        $testProj = Get-ChildItem -Recurse -Filter "*Tests.csproj" | Select-Object -First 1
        if ($testProj) {
          Write-Host "🔨 Compilando tests: $($testProj.Name)"
          msbuild $testProj.FullName /p:Configuration=${{ env.BUILD_CONFIGURATION }} /t:Rebuild
        }
    
    - name: Ejecutar tests unitarios
      run: |
        # Buscar DLL de tests
        $testDll = Get-ChildItem -Recurse -Filter "*Tests.dll" | Where-Object { $_.FullName -like "*\bin\Release\*" } | Select-Object -First 1
        
        if ($testDll) {
          Write-Host "✅ Tests encontrados en: $($testDll.FullName)"
          
          # Intentar con dotnet test primero
          dotnet test $testDll.FullName --no-build --verbosity normal --logger "console;verbosity=detailed"
          
          Write-Host "✅ Tests ejecutados exitosamente"
        } else {
          Write-Host "⚠️ No se encontraron archivos de tests (*Tests.dll)"
          Write-Host "Esto es normal si no tienes proyecto de tests configurado"
        }
      continue-on-error: false
    
    - name: Subir artefactos de build
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          **/bin/${{ env.BUILD_CONFIGURATION }}/*.dll
          **/bin/${{ env.BUILD_CONFIGURATION }}/*.exe


  # ==================== ETAPA 2: ANÁLISIS DE SEGURIDAD ====================
  security-scan:
    name: Escaneo de Seguridad
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v3
    
    - name: Escaneo de secretos con TruffleHog
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD
    
    - name: Análisis de código JavaScript
      if: always()
      run: |
        npm init -y
        npm install eslint eslint-plugin-security --save-dev
        cat > .eslintrc.json << 'EOF'
        {
          "extends": ["eslint:recommended"],
          "plugins": ["security"],
          "env": { "browser": true, "es2021": true },
          "rules": {
            "no-eval": "error",
            "no-implied-eval": "error",
            "security/detect-eval-with-expression": "error",
            "security/detect-unsafe-regex": "error"
          }
        }
        EOF
        npx eslint "**/*.js" || echo "⚠️ Se encontraron problemas de seguridad en JS"

  # ==================== ETAPA 3: CODEQL ANALYSIS ====================
  codeql:
    name: Análisis CodeQL
    runs-on: windows-latest
    needs: build-and-test
    permissions:
      security-events: write
      actions: read
      contents: read
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v3
    
    - name: Inicializar CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: csharp, javascript
        queries: security-and-quality
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1
    
    - name: Restaurar y compilar
      run: |
        nuget restore
        msbuild /p:Configuration=Release
    
    - name: Ejecutar análisis CodeQL
      uses: github/codeql-action/analyze@v2
      with:
        category: "/language:csharp,javascript"

  # ==================== ETAPA 4: QUALITY GATE ====================
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan, codeql]
    
    steps:
    - name: Verificar que todos los checks pasaron
      run: |
        echo "✅ Build: PASSED"
        echo "✅ Tests: PASSED"
        echo "✅ Security Scan: PASSED"
        echo "✅ CodeQL: PASSED"
        echo ""
        echo "🎉 Quality Gate: APPROVED"
        echo "✅ Listo para deploy"
    
    - name: Crear badge de status
      run: |
        echo "![Build Status](https://img.shields.io/badge/build-passing-brightgreen)" 
        echo "![Tests](https://img.shields.io/badge/tests-passing-brightgreen)"
        echo "![Security](https://img.shields.io/badge/security-passing-brightgreen)"

  # ==================== NOTIFICACIONES ====================
  notify-failure:
    name: Notificar Fallos
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan, codeql]
    if: failure()
    
    steps:
    - name: Notificación de fallo
      run: |
        echo "❌ El pipeline ha fallado"
        echo "Revisa los logs en: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
